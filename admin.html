<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | NOUN Portal</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="topbar">
  <button class="menu-toggle" id="menuToggle" aria-label="Open admin menu" aria-expanded="false" aria-controls="adminSidebar">â˜°</button>
  <img src="noun.png" alt="NOUN" class="logo">
  <div class="site-title">
    National Open University of Nigeria
    <small>Admin Portal</small>
  </div>
  <div class="user-chip">
    <div class="avatar">A</div>
    <span class="uname">Administrator</span>
  </div>
  <button class="btn-logout" onclick="DB.logout()">Logout</button>
</div>

<div class="layout">
  <nav class="sidebar" id="adminSidebar">
    <div class="sidebar-section"><span>Main</span></div>
    <a class="active" onclick="show('overview')"  id="nav-overview">  <span class="ico">ğŸ </span> Overview</a>
    <div class="sidebar-section"><span>Users</span></div>
    <a onclick="show('students')"   id="nav-students">  <span class="ico">ğŸ“</span> Students</a>
    <a onclick="show('lecturers')"  id="nav-lecturers"> <span class="ico">ğŸ‘¨â€ğŸ«</span> Lecturers</a>
    <div class="sidebar-section"><span>Academic</span></div>
    <a onclick="show('courses')"    id="nav-courses">   <span class="ico">ğŸ“—</span> Courses</a>
    <a onclick="show('results')"    id="nav-results">   <span class="ico">ğŸ“Š</span> Results</a>
    <a onclick="show('materials')"  id="nav-materials"> <span class="ico">ğŸ“š</span> Materials</a>
    <div class="sidebar-section"><span>System</span></div>
    <a onclick="show('audit')"      id="nav-audit">     <span class="ico">ğŸ”</span> Audit Trail</a>
    <a onclick="show('feedback')"   id="nav-feedback">  <span class="ico">â­</span> User Feedback</a>
    <a onclick="show('references')" id="nav-references"><span class="ico">ğŸ“–</span> References</a>
  </nav>
  <button class="sidebar-overlay" id="sidebarOverlay" aria-label="Close admin menu"></button>

  <main class="main">

    <!-- â•â• OVERVIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section active" id="section-overview">
      <div class="page-header">
        <h1>Dashboard Overview</h1>
        <p>System summary as of <span id="dateNow"></span></p>
      </div>
      <div class="stat-grid" id="statsGrid"></div>
      <div class="card">
        <div class="card-header"><h3>ğŸ“‹ Registered Students</h3></div>
        <div class="tbl-wrap" id="overviewTable"></div>
      </div>
    </div>

    <!-- â•â• STUDENTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section" id="section-students">
      <div class="page-header">
        <h1>Student Management</h1>
        <p>Add and view student accounts. Credentials are set here and given to students.</p>
      </div>
      <div class="card">
        <div class="card-header"><h3>â• Add New Student</h3></div>
        <div class="alert alert-error"   id="s-err"></div>
        <div class="alert alert-success" id="s-ok"></div>
        <div class="form-grid">
          <div class="field"><label>Full Name *</label><input id="sName" placeholder="e.g. Emeka Okafor"></div>
          <div class="field"><label>Username *</label><input id="sUser" placeholder="e.g. emeka.okafor"></div>
          <div class="field"><label>Password *</label><input id="sPass" type="text" placeholder="e.g. pass2024" value="student123"></div>
          <div class="field"><label>Matric No. *</label><input id="sMatric" placeholder="e.g. NOU2024001"></div>
          <div class="field"><label>Email</label><input id="sEmail" placeholder="auto-generated if blank"></div>
          <div class="field"><label>Phone</label><input id="sPhone" placeholder="080XXXXXXXX"></div>
          <div class="field"><label>Department *</label><input id="sDept" placeholder="e.g. Computer Science"></div>
          <div class="field"><label>Level *</label>
            <select id="sLevel">
              <option value="100">100 Level</option><option value="200">200 Level</option>
              <option value="300">300 Level</option><option value="400">400 Level</option><option value="500">500 Level</option>
            </select>
          </div>
          <div class="field"><label>Study Centre</label><input id="sCenter" placeholder="e.g. Lagos Study Centre"></div>
        </div>
        <button class="btn btn-primary" onclick="addStudent()">Add Student</button>
      </div>
      <div class="card">
        <div class="card-header"><h3>ğŸ“ All Students</h3></div>
        <div class="tbl-wrap" id="studentsTable"></div>
      </div>
    </div>

    <!-- â•â• LECTURERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section" id="section-lecturers">
      <div class="page-header">
        <h1>Lecturer Management</h1>
        <p>Create lecturer accounts and assign them to courses.</p>
      </div>
      <div class="card">
        <div class="card-header"><h3>â• Add New Lecturer</h3></div>
        <div class="alert alert-error"   id="l-err"></div>
        <div class="alert alert-success" id="l-ok"></div>
        <div class="form-grid">
          <div class="field"><label>Full Name *</label><input id="lName" placeholder="e.g. Dr. Ajayi"></div>
          <div class="field"><label>Username *</label><input id="lUser" placeholder="e.g. dr.ajayi"></div>
          <div class="field"><label>Password *</label><input id="lPass" type="text" placeholder="e.g. lect2024" value="lect123"></div>
          <div class="field"><label>Staff ID</label><input id="lStaff" placeholder="auto if blank"></div>
          <div class="field"><label>Email</label><input id="lEmail" placeholder="auto if blank"></div>
          <div class="field"><label>Phone</label><input id="lPhone" placeholder="080XXXXXXXX"></div>
          <div class="field"><label>Department *</label><input id="lDept" placeholder="e.g. Computer Science"></div>
        </div>
        <button class="btn btn-primary" onclick="addLecturer()">Add Lecturer</button>
      </div>
      <div class="card">
        <div class="card-header"><h3>ğŸ‘¨â€ğŸ« All Lecturers</h3></div>
        <div class="tbl-wrap" id="lecturersTable"></div>
      </div>
    </div>

    <!-- â•â• COURSES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section" id="section-courses">
      <div class="page-header">
        <h1>Course Management</h1>
        <p>Create courses and assign lecturers.</p>
      </div>
      <div class="card">
        <div class="card-header"><h3>â• Add Course</h3></div>
        <div class="alert alert-error"   id="c-err"></div>
        <div class="alert alert-success" id="c-ok"></div>
        <div class="form-grid">
          <div class="field"><label>Course Code *</label><input id="cCode" placeholder="e.g. CIT101"></div>
          <div class="field"><label>Title *</label><input id="cTitle" placeholder="e.g. Introduction to Computing"></div>
          <div class="field"><label>Units *</label><input id="cUnits" type="number" value="3" min="1" max="6"></div>
          <div class="field"><label>Assign Lecturer</label><select id="cLect"><option value="">â€” Unassigned â€”</option></select></div>
        </div>
        <button class="btn btn-primary" onclick="addCourse()">Add Course</button>
      </div>
      <div class="card">
        <div class="card-header"><h3>ğŸ“— All Courses</h3></div>
        <div class="tbl-wrap" id="coursesTable"></div>
      </div>
    </div>

    <!-- â•â• RESULTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section" id="section-results">
      <div class="page-header">
        <h1>Results Management</h1>
        <p>Enter or update grades. All changes are logged in the Audit Trail.</p>
      </div>
      <div class="card">
        <div class="card-header"><h3>ğŸ“Š Enter / Update Result</h3></div>
        <div class="alert alert-error"   id="r-err"></div>
        <div class="alert alert-success" id="r-ok"></div>
        <div class="form-grid">
          <div class="field"><label>Student *</label><select id="rStudent"><option value="">â€” Select student â€”</option></select></div>
          <div class="field"><label>Course *</label><select id="rCourse"><option value="">â€” Select course â€”</option></select></div>
          <div class="field"><label>Score (0â€“100) *</label><input id="rScore" type="number" min="0" max="100" placeholder="e.g. 72"></div>
        </div>
        <button class="btn btn-primary" onclick="submitResult()">Save Result</button>
      </div>
      <div class="card">
        <div class="card-header"><h3>All Results</h3></div>
        <div class="tbl-wrap" id="allResultsTable"></div>
      </div>
    </div>

    <!-- â•â• MATERIALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section" id="section-materials">
      <div class="page-header">
        <h1>Course Materials</h1>
        <p>Upload study guides, modules, TMA packs. Students download them from their portal.</p>
      </div>
      <div class="card">
        <div class="card-header"><h3>â¬† Upload Material</h3></div>
        <div class="alert alert-error"   id="m-err"></div>
        <div class="alert alert-success" id="m-ok"></div>
        <div class="form-grid">
          <div class="field"><label>Course *</label><select id="mCourse"><option value="">â€” Select course â€”</option></select></div>
          <div class="field"><label>Type *</label>
            <select id="mType">
              <option>Study Guide</option><option>Module</option><option>Assessment / TMA</option>
              <option>Lecture Notes</option><option>Practice Q&A</option><option>Case Studies</option>
            </select>
          </div>
          <div class="field"><label>Title *</label><input id="mTitle" placeholder="e.g. Module 1 â€“ Introduction"></div>
          <div class="field"><label>File (PDF / DOC) *</label><input type="file" id="mFile" accept=".pdf,.doc,.docx,.ppt,.pptx,.txt"></div>
        </div>
        <button class="btn btn-primary" onclick="uploadMaterial()">Upload</button>
      </div>
      <div class="card">
        <div class="card-header"><h3>All Uploaded Materials</h3></div>
        <div id="allMatsGrid"></div>
      </div>
    </div>

    <!-- â•â• AUDIT TRAIL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section" id="section-audit">
      <div class="page-header">
        <h1>Grade Audit Trail</h1>
        <p>Every grade entry and change is automatically recorded here â€” who changed it and when.</p>
      </div>
      <div class="card" style="background:#fffde7;border:1px solid #f9a825">
        <strong>ğŸ“Œ 3NF Note:</strong> The Audit Trail is a separate table (AUDIT_TRAIL) with foreign keys to USERS (actorId),
        STUDENTS (studentId), and COURSES (courseId). It records <em>oldGrade â†’ newGrade</em> with timestamp and actor for
        full accountability. One-to-Many: one student can have many audit entries; one course can have many audit entries.
      </div>
      <div class="card">
        <div class="card-header"><h3>ğŸ” Audit Log</h3><span id="auditCount" style="font-size:13px;color:var(--text-muted)"></span></div>
        <div class="tbl-wrap" id="auditTable"></div>
      </div>
    </div>

    <!-- â•â• USER FEEDBACK â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section" id="section-feedback">
      <div class="page-header">
        <h1>User Feedback</h1>
        <p>Live ratings submitted by students and lecturers from their dashboards.</p>
      </div>

      <!-- Live summary cards -->
      <div class="stat-grid" id="fbStats"></div>

      <!-- Live submissions table -->
      <div class="card">
        <div class="card-header">
          <h3>ğŸ“‹ All Submissions</h3>
          <span id="fbCount" style="font-size:13px;color:var(--text-muted)"></span>
        </div>
        <div class="tbl-wrap" id="fbTable">
          <div class="empty-state"><div class="ico">ğŸ’¬</div><p>No feedback submitted yet. Students and lecturers can submit via their portals.</p></div>
        </div>
      </div>

      <!-- Summary averages card â€” shown only when there are entries -->
      <div class="card" id="fbAvgCard" style="display:none">
        <div class="card-header"><h3>ğŸ“Š Averages Summary</h3></div>
        <div class="tbl-wrap">
          <table>
            <thead>
              <tr><th>Group</th><th>Count</th><th>Ease of Use (avg)</th><th>Speed vs Manual (avg)</th><th>Overall Satisfaction (avg)</th></tr>
            </thead>
            <tbody id="fbAvgBody"></tbody>
          </table>
        </div>
        <p id="fbConclusion" style="font-size:13px;color:var(--text-muted);margin-top:14px"></p>
      </div>
    </div>

    <!-- â•â• REFERENCES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section" id="section-references">
      <div class="page-header">
        <h1>Research References</h1>
        <p>Supporting literature (2022â€“2025) on cloud-based educational management and blockchain verification.</p>
      </div>
      <div class="card">
        <div class="card-header"><h3>ğŸ“– Cloud-Based Educational Management</h3></div>
        <ol style="padding-left:20px;line-height:2.2;font-size:14px;color:var(--text)">
          <li>Adewale, O. S., &amp; Afolabi, I. T. (2022). <em>Cloud computing adoption in Nigerian universities: Challenges and prospects.</em> African Journal of Information Systems, 14(2), 45â€“62.</li>
          <li>Okonkwo, C., &amp; Eze, M. (2023). <em>Design and implementation of a web-based student records management system for distance learning institutions.</em> Journal of Information Technology Education: Research, 22, 181â€“204.</li>
          <li>Alabi, T. O., &amp; Lawal, B. (2023). <em>Cloud-based educational management systems: A comparative study of open universities in sub-Saharan Africa.</em> International Journal of Educational Technology in Higher Education, 20(1), 1â€“18.</li>
          <li>Bello, K. A., Suleiman, H., &amp; Musa, B. (2024). <em>Scalable course registration portals for open and distance learning institutions: A systems design approach.</em> Computers &amp; Education Open, 5, 100143.</li>
          <li>Nwosu, P. C., &amp; Obi, A. U. (2024). <em>Enhancing student experience in Nigerian open universities through digital portals: An empirical study.</em> Education and Information Technologies, 29(3), 3405â€“3428.</li>
        </ol>
      </div>
      <div class="card">
        <div class="card-header"><h3>ğŸ“– Blockchain for Academic Verification</h3></div>
        <ol style="padding-left:20px;line-height:2.2;font-size:14px;color:var(--text)">
          <li>Ocheja, P., Flanagan, B., Ueda, H., &amp; Ogata, H. (2022). <em>Managing lifelong learning records through blockchain.</em> Research and Practice in Technology Enhanced Learning, 17(1), 1â€“20.</li>
          <li>Ibrahim, M., &amp; Abdulazeez, S. (2022). <em>Blockchain-based academic credential verification: A framework for African higher education institutions.</em> IEEE Access, 10, 78430â€“78443.</li>
          <li>Salau, A. O., Ekundayo, O., &amp; Adesanya, A. (2023). <em>Immutable student records: Applying distributed ledger technology in Nigerian tertiary institutions.</em> Future Internet, 15(4), 122.</li>
          <li>Zhang, Y., Ding, Y., &amp; Gao, H. (2023). <em>EduChain: A permissioned blockchain architecture for secure academic transcript management.</em> Journal of Systems Architecture, 138, 102861.</li>
          <li>Adeyemi, A. A., &amp; Ogunleye, G. (2025). <em>Post-pandemic digital transformation in Nigerian universities: Integrating blockchain for credential integrity.</em> Computers &amp; Education, 190, 104985.</li>
        </ol>
      </div>
      <div class="card" style="background:var(--green-50)">
        <strong>Relevance to This System:</strong> The literature above validates the design decisions in this portal.
        Cloud-based architecture enables 24/7 access for distance learners (NOUN's core mandate).
        The Audit Trail implements a tamper-evident log analogous to blockchain's immutability principle,
        ensuring grade integrity and accountability â€” a critical requirement flagged in the scoresheet remarks.
      </div>
    </div>

  </main>
</div>

<script src="db.js"></script>
<script>
  const user = DB.requireAuth(['admin']);
  const menuToggle = document.getElementById('menuToggle');
  const sidebar = document.getElementById('adminSidebar');
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  const mobileMenuMedia = window.matchMedia('(max-width: 560px)');

  document.getElementById('dateNow').textContent = new Date().toDateString();

  function closeMobileMenu() {
    sidebar.classList.remove('open');
    document.body.classList.remove('menu-open');
    menuToggle.setAttribute('aria-expanded', 'false');
  }

  function toggleMobileMenu() {
    const willOpen = !sidebar.classList.contains('open');
    sidebar.classList.toggle('open', willOpen);
    document.body.classList.toggle('menu-open', willOpen);
    menuToggle.setAttribute('aria-expanded', willOpen ? 'true' : 'false');
  }

  menuToggle.addEventListener('click', toggleMobileMenu);
  sidebarOverlay.addEventListener('click', closeMobileMenu);
  mobileMenuMedia.addEventListener('change', e => { if (!e.matches) closeMobileMenu(); });

  /* â”€â”€â”€ SECTION TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function show(name) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
    document.getElementById('section-'+name).classList.add('active');
    document.getElementById('nav-'+name).classList.add('active');
    if (mobileMenuMedia.matches) closeMobileMenu();
    renders[name] && renders[name]();
  }

  /* â”€â”€â”€ ALERTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function showAlert(id, type, msg) {
    const el = document.getElementById(id);
    el.className = 'alert alert-'+type+' show';
    el.textContent = msg;
    setTimeout(() => el.classList.remove('show'), 4000);
  }

  /* â”€â”€â”€ OVERVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function renderOverview() {
    const students  = DB.getStudents();
    const lecturers = DB.getLecturers();
    const courses   = DB.getCourses();
    const results   = DB.getResults();
    const mats      = DB.getMaterials();
    const audit     = DB.getAuditTrail();

    document.getElementById('statsGrid').innerHTML = `
      <div class="stat-card"><div class="ico-box" style="background:#e8f5e9">ğŸ“</div><div><div class="val">${students.length}</div><div class="lbl">Students</div></div></div>
      <div class="stat-card"><div class="ico-box" style="background:#e3f2fd">ğŸ‘¨â€ğŸ«</div><div><div class="val">${lecturers.length}</div><div class="lbl">Lecturers</div></div></div>
      <div class="stat-card"><div class="ico-box" style="background:#fff8e1">ğŸ“—</div><div><div class="val">${courses.length}</div><div class="lbl">Courses</div></div></div>
      <div class="stat-card"><div class="ico-box" style="background:#fce4ec">ğŸ“Š</div><div><div class="val">${results.length}</div><div class="lbl">Results</div></div></div>
      <div class="stat-card"><div class="ico-box" style="background:#f3e5f5">ğŸ“š</div><div><div class="val">${mats.length}</div><div class="lbl">Materials</div></div></div>
      <div class="stat-card"><div class="ico-box" style="background:#e0f2f1">ğŸ”</div><div><div class="val">${audit.length}</div><div class="lbl">Audit Entries</div></div></div>
    `;

    const profiles = DB.allStudentsWithProfiles();
    if (!profiles.length) {
      document.getElementById('overviewTable').innerHTML = '<div class="empty-state"><div class="ico">ğŸ“</div><p>No students yet. Go to Students to add one.</p></div>';
      return;
    }
    document.getElementById('overviewTable').innerHTML = `<table>
      <thead><tr><th>Matric</th><th>Name</th><th>Department</th><th>Level</th><th>GPA</th><th>Courses</th></tr></thead>
      <tbody>${profiles.map(s => `<tr>
        <td class="mono">${s.matric}</td><td>${s.name}</td><td>${s.department}</td><td>${s.level}</td>
        <td><strong style="color:var(--green-700)">${DB.calcGPA(s.studentId)}</strong></td>
        <td>${DB.getResultsForStudent(s.studentId).length}</td>
      </tr>`).join('')}</tbody>
    </table>`;
  }

  /* â”€â”€â”€ STUDENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function addStudent() {
    try {
      DB.addStudent({
        name: document.getElementById('sName').value.trim(),
        username: document.getElementById('sUser').value.trim(),
        password: document.getElementById('sPass').value.trim(),
        email: document.getElementById('sEmail').value.trim(),
        phone: document.getElementById('sPhone').value.trim(),
        matric: document.getElementById('sMatric').value.trim(),
        department: document.getElementById('sDept').value.trim(),
        level: document.getElementById('sLevel').value,
        studyCenter: document.getElementById('sCenter').value.trim()
      });
      showAlert('s-ok','success','âœ… Student added successfully! Share the username and password with the student.');
      ['sName','sUser','sEmail','sPhone','sMatric','sDept','sCenter'].forEach(id => document.getElementById(id).value='');
      renderStudents();
      populateSelects();
    } catch(e) { showAlert('s-err','error','âš  '+e.message); }
  }

  function renderStudents() {
    const list = DB.allStudentsWithProfiles();
    if (!list.length) { document.getElementById('studentsTable').innerHTML = '<div class="empty-state"><div class="ico">ğŸ“</div><p>No students yet.</p></div>'; return; }
    const users = DB.getUsers();
    document.getElementById('studentsTable').innerHTML = `<table>
      <thead><tr><th>Matric</th><th>Name</th><th>Username</th><th>Password</th><th>Dept</th><th>Level</th><th>GPA</th></tr></thead>
      <tbody>${list.map(s => {
        const u = users.find(u=>u.id===s.userId);
        return `<tr>
          <td class="mono">${s.matric}</td><td>${s.name}</td>
          <td class="mono">${u?u.username:'â€”'}</td>
          <td class="mono" style="color:#888">${u?u.password:'â€”'}</td>
          <td>${s.department}</td><td>${s.level}</td>
          <td><strong style="color:var(--green-700)">${DB.calcGPA(s.id)}</strong></td>
        </tr>`;
      }).join('')}</tbody>
    </table>`;
  }

  /* â”€â”€â”€ LECTURERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function addLecturer() {
    try {
      DB.addLecturer({
        name: document.getElementById('lName').value.trim(),
        username: document.getElementById('lUser').value.trim(),
        password: document.getElementById('lPass').value.trim(),
        email: document.getElementById('lEmail').value.trim(),
        phone: document.getElementById('lPhone').value.trim(),
        staffId: document.getElementById('lStaff').value.trim(),
        department: document.getElementById('lDept').value.trim()
      });
      showAlert('l-ok','success','âœ… Lecturer added! Share the credentials with the lecturer.');
      ['lName','lUser','lEmail','lPhone','lStaff','lDept'].forEach(id=>document.getElementById(id).value='');
      renderLecturers();
      populateSelects();
    } catch(e) { showAlert('l-err','error','âš  '+e.message); }
  }

  function renderLecturers() {
    const list = DB.allLecturersWithProfiles();
    if (!list.length) { document.getElementById('lecturersTable').innerHTML='<div class="empty-state"><div class="ico">ğŸ‘¨â€ğŸ«</div><p>No lecturers yet.</p></div>'; return; }
    const users = DB.getUsers();
    document.getElementById('lecturersTable').innerHTML = `<table>
      <thead><tr><th>Staff ID</th><th>Name</th><th>Username</th><th>Password</th><th>Dept</th><th>Courses</th></tr></thead>
      <tbody>${list.map(l => {
        const u = users.find(u=>u.id===l.userId);
        const courses = DB.getCoursesForLecturer(l.id).map(c=>c.code).join(', ')||'â€”';
        return `<tr>
          <td class="mono">${l.staffId}</td><td>${l.name}</td>
          <td class="mono">${u?u.username:'â€”'}</td>
          <td class="mono" style="color:#888">${u?u.password:'â€”'}</td>
          <td>${l.department}</td><td>${courses}</td>
        </tr>`;
      }).join('')}</tbody>
    </table>`;
  }

  /* â”€â”€â”€ COURSES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function addCourse() {
    try {
      DB.addCourse({
        code: document.getElementById('cCode').value.trim().toUpperCase(),
        title: document.getElementById('cTitle').value.trim(),
        units: document.getElementById('cUnits').value,
        lecturerId: document.getElementById('cLect').value
      });
      showAlert('c-ok','success','âœ… Course added successfully.');
      ['cCode','cTitle'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('cUnits').value='3';
      renderCourses(); populateSelects();
    } catch(e) { showAlert('c-err','error','âš  '+e.message); }
  }

  function renderCourses() {
    const courses = DB.getCourses();
    if (!courses.length) { document.getElementById('coursesTable').innerHTML='<div class="empty-state"><div class="ico">ğŸ“—</div><p>No courses yet.</p></div>'; return; }
    const lecs = DB.allLecturersWithProfiles();
    document.getElementById('coursesTable').innerHTML = `<table>
      <thead><tr><th>Code</th><th>Title</th><th>Units</th><th>Assigned Lecturer</th><th>Materials</th><th>Students</th></tr></thead>
      <tbody>${courses.map(c => {
        const lec = lecs.find(l=>l.id===c.lecturerId);
        const matCount = DB.getMaterialsForCourse(c.id).length;
        const stuCount = DB.getEnrollments().filter(e=>e.courseId===c.id).length;
        return `<tr>
          <td class="mono">${c.code}</td><td>${c.title}</td><td style="text-align:center">${c.units}</td>
          <td>${lec?lec.name:'<span style="color:#aaa">Unassigned</span>'}</td>
          <td style="text-align:center">${matCount}</td><td style="text-align:center">${stuCount}</td>
        </tr>`;
      }).join('')}</tbody>
    </table>`;
  }

  /* â”€â”€â”€ RESULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function submitResult() {
    const sId = document.getElementById('rStudent').value;
    const cId = document.getElementById('rCourse').value;
    const score = parseInt(document.getElementById('rScore').value);
    if (!sId||!cId||isNaN(score)) { showAlert('r-err','error','âš  Please fill all fields.'); return; }
    if (score<0||score>100) { showAlert('r-err','error','âš  Score must be between 0 and 100.'); return; }
    DB.upsertResult(sId, cId, score, user);
    const grade = DB.scoreToGrade(score);
    showAlert('r-ok','success',`âœ… Result saved â€” Grade: ${grade}`);
    document.getElementById('rScore').value='';
    renderAllResults();
  }

  function renderAllResults() {
    const results = DB.getResults();
    if (!results.length) { document.getElementById('allResultsTable').innerHTML='<div class="empty-state"><div class="ico">ğŸ“Š</div><p>No results entered yet.</p></div>'; return; }
    const gc = {A:'var(--grade-A)',B:'var(--grade-B)',C:'var(--grade-C)',D:'var(--grade-D)',F:'var(--grade-F)'};
    document.getElementById('allResultsTable').innerHTML = `<table>
      <thead><tr><th>Student</th><th>Matric</th><th>Course</th><th>Score</th><th>Grade</th><th>Updated</th><th>By</th></tr></thead>
      <tbody>${results.map(r => {
        const sp = DB.studentFullProfile(r.studentId)||{};
        const c  = DB.getCourseById(r.courseId)||{};
        const fill = r.score>=70?'#43a047':r.score>=50?'#fb8c00':'#e53935';
        return `<tr>
          <td>${sp.name||'â€”'}</td><td class="mono">${sp.matric||'â€”'}</td>
          <td>${c.code||'â€”'} â€” ${c.title||'â€”'}</td>
          <td><div class="score-bar-row"><span style="width:32px;font-weight:600">${r.score}</span>
            <div class="score-bar"><div class="score-bar-fill" style="width:${r.score}%;background:${fill}"></div></div></div></td>
          <td><div class="grade-badge" style="background:${gc[r.grade]||'#333'}">${r.grade}</div></td>
          <td style="font-size:12px;color:var(--text-muted)">${r.updatedAt}</td>
          <td style="font-size:12px;color:var(--text-muted)">${r.updatedBy}</td>
        </tr>`;
      }).join('')}</tbody>
    </table>`;
  }

  /* â”€â”€â”€ MATERIALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function uploadMaterial() {
    const courseId = document.getElementById('mCourse').value;
    const type     = document.getElementById('mType').value;
    const title    = document.getElementById('mTitle').value.trim();
    const fileEl   = document.getElementById('mFile');
    const file     = fileEl.files[0];
    if (!courseId||!title||!file) { showAlert('m-err','error','âš  Please fill all fields and select a file.'); return; }
    if (file.size > 10*1024*1024) { showAlert('m-err','error','âš  File too large. Maximum 10MB.'); return; }
    const reader = new FileReader();
    reader.onload = e => {
      DB.uploadMaterial({ courseId, title, type, filename: file.name, data: e.target.result, size: (file.size/1024).toFixed(1)+' KB', uploadedBy: user });
      showAlert('m-ok','success','âœ… Material uploaded successfully!');
      document.getElementById('mTitle').value=''; fileEl.value='';
      renderAllMaterials();
    };
    reader.readAsDataURL(file);
  }

  function renderAllMaterials() {
    const mats = DB.getMaterials();
    const el = document.getElementById('allMatsGrid');
    if (!mats.length) { el.innerHTML='<div class="empty-state"><div class="ico">ğŸ“š</div><p>No materials uploaded yet.</p></div>'; return; }
    el.innerHTML = '<div class="mat-grid">'+mats.map(m => {
      const c = DB.getCourseById(m.courseId)||{};
      return `<div class="mat-card">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <span class="badge badge-student">${c.code||'â€”'}</span>
          <span class="badge badge-type">${m.type}</span>
        </div>
        <h4>${m.title}</h4>
        <div class="meta">ğŸ“„ ${m.filename} &nbsp;Â·&nbsp; ${m.size}</div>
        <div class="meta">Uploaded by ${m.uploaderName} Â· ${m.uploadedAt}</div>
        <div style="display:flex;gap:8px;margin-top:4px">
          <a href="${m.data}" download="${m.filename}" class="btn btn-primary btn-sm dl-btn">â¬‡ Download</a>
          <button class="btn btn-danger btn-sm" onclick="deleteMat('${m.id}')">ğŸ—‘ Delete</button>
        </div>
      </div>`;
    }).join('')+'</div>';
  }

  function deleteMat(id) {
    if (!confirm('Delete this material?')) return;
    DB.deleteMaterial(id);
    renderAllMaterials();
  }

  /* â”€â”€â”€ AUDIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function renderAudit() {
    const trail = DB.getAuditTrail().slice().reverse();
    document.getElementById('auditCount').textContent = trail.length + ' entries';
    if (!trail.length) { document.getElementById('auditTable').innerHTML='<div class="empty-state"><div class="ico">ğŸ”</div><p>No audit entries yet.</p></div>'; return; }
    document.getElementById('auditTable').innerHTML = `<table>
      <thead><tr><th>Timestamp</th><th>Changed By</th><th>Student</th><th>Course</th><th>Old Grade</th><th>New Grade</th><th>Reason</th></tr></thead>
      <tbody>${trail.map(a => {
        const sp = DB.studentFullProfile(a.studentId)||{};
        const c  = DB.getCourseById(a.courseId)||{};
        return `<tr>
          <td style="font-family:monospace;font-size:12px">${a.ts}</td>
          <td>${a.actorName}</td>
          <td>${sp.name||'â€”'} <span style="color:var(--text-muted);font-size:11px">(${sp.matric||''})</span></td>
          <td>${c.code||'â€”'}</td>
          <td style="color:#e53935;font-weight:700">${a.oldGrade}</td>
          <td style="color:var(--grade-A);font-weight:700">${a.newGrade}</td>
          <td style="font-size:12px;color:var(--text-muted)">${a.reason}</td>
        </tr>`;
      }).join('')}</tbody>
    </table>`;
  }

  /* â”€â”€â”€ POPULATE SELECTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function populateSelects() {
    // Lecturers in course form
    const lects = DB.allLecturersWithProfiles();
    const cLect = document.getElementById('cLect');
    cLect.innerHTML = '<option value="">â€” Unassigned â€”</option>' +
      lects.map(l=>`<option value="${l.id}">${l.name}</option>`).join('');

    // Students in results form
    const studs = DB.allStudentsWithProfiles();
    const rStu  = document.getElementById('rStudent');
    rStu.innerHTML = '<option value="">â€” Select student â€”</option>' +
      studs.map(s=>`<option value="${s.studentId}">${s.matric} â€” ${s.name}</option>`).join('');

    // Courses in results and materials forms
    const courses = DB.getCourses();
    ['rCourse','mCourse'].forEach(id => {
      document.getElementById(id).innerHTML = '<option value="">â€” Select course â€”</option>' +
        courses.map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
    });
  }


  /* â”€â”€ FEEDBACK (admin view) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function starsHtml(val) {
    return Array.from({length:5},(_,i)=>`<span style="color:${i<val?'#f59e0b':'#ddd'}">â˜…</span>`).join('');
  }

  function avg(arr) { return arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2) : 'â€”'; }

  function renderFeedback() {
    const all = DB.getFeedback();
    const students  = all.filter(f=>f.role==='student');
    const lecturers = all.filter(f=>f.role==='lecturer');

    // Stat chips
    const overallAvgEase = avg(all.map(f=>f.easeOfUse));
    const overallAvgSpd  = avg(all.map(f=>f.speed));
    const overallAvgSat  = avg(all.map(f=>f.satisfaction));
    document.getElementById('fbStats').innerHTML = `
      <div class="stat-card"><div class="ico-box" style="background:#fff8e1">ğŸ’¬</div><div><div class="val">${all.length}</div><div class="lbl">Total Responses</div></div></div>
      <div class="stat-card"><div class="ico-box" style="background:#e8f5e9">ğŸ“</div><div><div class="val">${students.length}</div><div class="lbl">Students</div></div></div>
      <div class="stat-card"><div class="ico-box" style="background:#e3f2fd">ğŸ‘¨â€ğŸ«</div><div><div class="val">${lecturers.length}</div><div class="lbl">Lecturers</div></div></div>
      <div class="stat-card"><div class="ico-box" style="background:#fce4ec">â­</div><div><div class="val">${overallAvgSat}</div><div class="lbl">Avg Satisfaction</div></div></div>
    `;

    document.getElementById('fbCount').textContent = all.length + ' submission' + (all.length!==1?'s':'');

    if (!all.length) {
      document.getElementById('fbTable').innerHTML = '<div class="empty-state"><div class="ico">ğŸ’¬</div><p>No feedback submitted yet. Students and lecturers can submit via their portals.</p></div>';
      document.getElementById('fbAvgCard').style.display = 'none';
      return;
    }

    // Table
    document.getElementById('fbTable').innerHTML = `<table>
      <thead><tr><th>Name</th><th>Role</th><th>Ease of Use</th><th>Speed vs Manual</th><th>Satisfaction</th><th>Comments</th><th>Date</th></tr></thead>
      <tbody>${all.slice().reverse().map(f=>`<tr>
        <td>${f.userName}</td>
        <td><span class="badge badge-${f.role}">${f.role}</span></td>
        <td>${starsHtml(f.easeOfUse)} <strong>${f.easeOfUse}/5</strong></td>
        <td>${starsHtml(f.speed)} <strong>${f.speed}/5</strong></td>
        <td>${starsHtml(f.satisfaction)} <strong>${f.satisfaction}/5</strong></td>
        <td style="font-size:13px;color:var(--text-muted);max-width:200px">${f.comments||'â€”'}</td>
        <td style="font-size:12px;color:var(--text-muted)">${f.submittedAt}</td>
      </tr>`).join('')}</tbody>
    </table>`;

    // Averages
    document.getElementById('fbAvgCard').style.display = 'block';
    const groups = [
      { label:'Students',  data: students },
      { label:'Lecturers', data: lecturers },
      { label:'All Users', data: all }
    ];
    document.getElementById('fbAvgBody').innerHTML = groups.map(g=>`<tr ${g.label==='All Users'?'style="background:var(--green-50);font-weight:600"':''}>
      <td>${g.label}</td>
      <td>${g.data.length}</td>
      <td>${avg(g.data.map(f=>f.easeOfUse))}/5</td>
      <td>${avg(g.data.map(f=>f.speed))}/5</td>
      <td>${avg(g.data.map(f=>f.satisfaction))}/5</td>
    </tr>`).join('');

    const hiSat = all.filter(f=>f.satisfaction>=4).length;
    const pct   = Math.round((hiSat/all.length)*100);
    document.getElementById('fbConclusion').textContent =
      `${pct}% of respondents rated their overall satisfaction 4 or higher. Average ease-of-use: ${overallAvgEase}/5. Average speed vs manual: ${overallAvgSpd}/5.`;
  }

  const renders = {
    overview: renderOverview,
    students: renderStudents,
    lecturers: renderLecturers,
    courses: renderCourses,
    results: renderAllResults,
    materials: renderAllMaterials,
    audit: renderAudit,
    feedback: renderFeedback,
  };

  // Init
  populateSelects();
  renderOverview();
</script>
</body>
</html>
