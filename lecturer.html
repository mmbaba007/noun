<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lecturer Dashboard | NOUN Portal</title>
  <link rel="stylesheet" href="styles.css">
<style>
.star-row { display:flex; gap:6px; margin-top:6px; }
.star { font-size:28px; cursor:pointer; color:#ddd; transition:color 0.15s; user-select:none; }
.star.active { color:#f59e0b; }
.star:hover { color:#f59e0b; }
.fb-display-row { display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid var(--border); font-size:14px; }
.fb-display-row:last-child { border:none; }
.fb-stars { color:#f59e0b; font-size:16px; }
</style>

</head>
<body>

<div class="topbar">
  <img src="noun.png" alt="NOUN" class="logo">
  <div class="site-title">
    National Open University of Nigeria
    <small>Lecturer Portal</small>
  </div>
  <div class="user-chip">
    <div class="avatar" id="topAvatar">L</div>
    <span class="uname" id="topName">Lecturer</span>
  </div>
  <button class="btn-logout" onclick="DB.logout()">Logout</button>
</div>

<div class="layout">
  <nav class="sidebar">
    <div class="sidebar-section"><span>Main</span></div>
    <a class="active" onclick="show('overview')"  id="nav-overview"> <span class="ico">ğŸ </span> Overview</a>
    <div class="sidebar-section"><span>Academic</span></div>
    <a onclick="show('students')"   id="nav-students">  <span class="ico">ğŸ“</span> My Students</a>
    <a onclick="show('results')"    id="nav-results">   <span class="ico">ğŸ“Š</span> Upload Results</a>
    <a onclick="show('materials')"  id="nav-materials"> <span class="ico">ğŸ“š</span> Upload Materials</a>
    <a onclick="show('audit')"      id="nav-audit">     <span class="ico">ğŸ”</span> Audit Trail</a>
    <a onclick="show('feedback')"   id="nav-feedback">  <span class="ico">â­</span> Feedback</a>
  </nav>

  <main class="main">

    <!-- OVERVIEW -->
    <div class="section active" id="section-overview">
      <div class="page-header">
        <h1 id="welcomeTitle">Welcome!</h1>
        <p id="welcomeSub">Lecturer Portal</p>
      </div>
      <div class="stat-grid" id="statsGrid"></div>
      <div class="card">
        <div class="card-header"><h3>Your Assigned Courses</h3></div>
        <div id="myCoursesList"></div>
      </div>
    </div>

    <!-- MY STUDENTS -->
    <div class="section" id="section-students">
      <div class="page-header">
        <h1>My Students</h1>
        <p>Students enrolled in your courses</p>
      </div>
      <div class="card">
        <div class="card-header"><h3>ğŸ“ Student Roster</h3></div>
        <div class="tbl-wrap" id="studentsTable"></div>
      </div>
    </div>

    <!-- RESULTS -->
    <div class="section" id="section-results">
      <div class="page-header">
        <h1>Upload Results</h1>
        <p>Enter grades for students in your courses. All changes are audited.</p>
      </div>
      <div class="card">
        <div class="card-header"><h3>ğŸ“Š Enter / Update Grade</h3></div>
        <div class="alert alert-error"   id="r-err"></div>
        <div class="alert alert-success" id="r-ok"></div>
        <div class="form-grid">
          <div class="field"><label>Student *</label><select id="rStudent"><option value="">â€” Select student â€”</option></select></div>
          <div class="field"><label>Course (Your courses only) *</label><select id="rCourse"><option value="">â€” Select course â€”</option></select></div>
          <div class="field"><label>Score (0â€“100) *</label><input id="rScore" type="number" min="0" max="100" placeholder="e.g. 72"></div>
        </div>
        <button class="btn btn-primary" onclick="submitResult()">Save Result</button>
      </div>
      <div class="card">
        <div class="card-header"><h3>All Results in Your Courses</h3></div>
        <div class="tbl-wrap" id="resultsTable"></div>
      </div>
    </div>

    <!-- MATERIALS -->
    <div class="section" id="section-materials">
      <div class="page-header">
        <h1>Upload Materials</h1>
        <p>Upload study guides, modules, and assessments for enrolled students.</p>
      </div>
      <div class="card">
        <div class="card-header"><h3>â¬† Upload Material</h3></div>
        <div class="alert alert-error"   id="m-err"></div>
        <div class="alert alert-success" id="m-ok"></div>
        <div class="form-grid">
          <div class="field"><label>Course *</label><select id="mCourse"><option value="">â€” Select course â€”</option></select></div>
          <div class="field"><label>Type *</label>
            <select id="mType">
              <option>Study Guide</option><option>Module</option><option>Assessment / TMA</option>
              <option>Lecture Notes</option><option>Practice Q&A</option><option>Case Studies</option>
            </select>
          </div>
          <div class="field"><label>Title *</label><input id="mTitle" placeholder="e.g. Week 3 Lecture Notes"></div>
          <div class="field"><label>File *</label><input type="file" id="mFile" accept=".pdf,.doc,.docx,.ppt,.pptx,.txt"></div>
        </div>
        <button class="btn btn-primary" onclick="uploadMaterial()">Upload</button>
      </div>
      <div class="card">
        <div class="card-header"><h3>Uploaded Materials</h3></div>
        <div id="matsGrid"></div>
      </div>
    </div>

    <!-- AUDIT TRAIL -->
    <div class="section" id="section-audit">
      <div class="page-header">
        <h1>Audit Trail</h1>
        <p>All grade changes you made â€” automatically logged for accountability.</p>
      </div>
      <div class="card">
        <div class="card-header"><h3>ğŸ” My Grade Change Log</h3></div>
        <div class="tbl-wrap" id="auditTable"></div>
      </div>
    </div>


    <!-- FEEDBACK -->
    <div class="section" id="section-feedback">
      <div class="page-header">
        <h1>Share Your Feedback</h1>
        <p>Rate your experience with the NOUN portal compared to the previous manual process.</p>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
        <div class="card">
          <div class="card-header"><h3>â­ Submit Your Rating</h3></div>
          <div class="alert alert-error"   id="fb-err"></div>
          <div class="alert alert-success" id="fb-ok"></div>
          <div id="fbAlreadyMsg" style="display:none;background:var(--green-50);border:1px solid var(--green-400);border-radius:8px;padding:12px 14px;margin-bottom:14px;font-size:13px;color:var(--green-800)">
            âœ… You have already submitted feedback. You can update it below.
          </div>
          <div class="field" style="margin-bottom:16px">
            <label>Ease of Use (1 = very difficult, 5 = very easy)</label>
            <div class="star-row" id="s-ease"></div>
            <input type="hidden" id="fbEase" value="0">
          </div>
          <div class="field" style="margin-bottom:16px">
            <label>Speed vs Manual Process (1 = slower, 5 = much faster)</label>
            <div class="star-row" id="s-speed"></div>
            <input type="hidden" id="fbSpeed" value="0">
          </div>
          <div class="field" style="margin-bottom:16px">
            <label>Overall Satisfaction (1 = poor, 5 = excellent)</label>
            <div class="star-row" id="s-sat"></div>
            <input type="hidden" id="fbSat" value="0">
          </div>
          <div class="field" style="margin-bottom:18px">
            <label>Comments (optional)</label>
            <textarea id="fbComment" rows="3" style="width:100%;padding:10px 13px;border-radius:8px;border:1.5px solid var(--border);font-family:inherit;font-size:14px;resize:vertical;outline:none" placeholder="Share your thoughts..."></textarea>
          </div>
          <button class="btn btn-primary btn-full" onclick="submitFeedback()">Submit Feedback</button>
        </div>
        <div class="card">
          <div class="card-header"><h3>ğŸ“Š Your Previous Submission</h3></div>
          <div id="myFeedbackDisplay">
            <div class="empty-state"><div class="ico">ğŸ’¬</div><p>You haven't submitted feedback yet.</p></div>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<script src="db.js"></script>
<script>
  const user = DB.requireAuth(['lecturer']);
  const lec  = DB.getLecturerByUserId(user.id);

  document.getElementById('topName').textContent    = user.name;
  document.getElementById('topAvatar').textContent  = user.name.charAt(0);
  document.getElementById('welcomeTitle').textContent = 'Welcome, ' + user.name;
  document.getElementById('welcomeSub').textContent = lec ? lec.department : 'Lecturer Portal';

  const myCourses = lec ? DB.getCoursesForLecturer(lec.id) : [];
  const myCourseIds = myCourses.map(c=>c.id);

  function show(name) {
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.querySelectorAll('.sidebar a').forEach(a=>a.classList.remove('active'));
    document.getElementById('section-'+name).classList.add('active');
    document.getElementById('nav-'+name).classList.add('active');
    renders[name] && renders[name]();
  }

  function showAlert(id, type, msg) {
    const el = document.getElementById(id);
    el.className = 'alert alert-'+type+' show';
    el.textContent = msg;
    setTimeout(()=>el.classList.remove('show'),4000);
  }

  /* OVERVIEW */
  function renderOverview() {
    // Stats
    const enrolled   = DB.getEnrollments().filter(e=>myCourseIds.includes(e.courseId));
    const studentIds = [...new Set(enrolled.map(e=>e.studentId))];
    const myResults  = DB.getResults().filter(r=>myCourseIds.includes(r.courseId));
    const myMats     = DB.getMaterials().filter(m=>myCourseIds.includes(m.courseId));
    const myAudit    = DB.getAuditTrail().filter(a=>a.actorId===user.id);

    document.getElementById('statsGrid').innerHTML = `
      <div class="stat-card"><div class="ico-box" style="background:#e8f5e9">ğŸ“—</div><div><div class="val">${myCourses.length}</div><div class="lbl">Courses</div></div></div>
      <div class="stat-card"><div class="ico-box" style="background:#e3f2fd">ğŸ“</div><div><div class="val">${studentIds.length}</div><div class="lbl">Students</div></div></div>
      <div class="stat-card"><div class="ico-box" style="background:#fff8e1">ğŸ“Š</div><div><div class="val">${myResults.length}</div><div class="lbl">Results</div></div></div>
      <div class="stat-card"><div class="ico-box" style="background:#f3e5f5">ğŸ“š</div><div><div class="val">${myMats.length}</div><div class="lbl">Materials</div></div></div>
    `;

    if (!myCourses.length) {
      document.getElementById('myCoursesList').innerHTML = '<div class="empty-state"><div class="ico">ğŸ“—</div><p>No courses assigned yet. Contact admin.</p></div>';
      return;
    }
    document.getElementById('myCoursesList').innerHTML = `<table>
      <thead><tr><th>Code</th><th>Title</th><th>Units</th><th>Enrolled Students</th><th>Materials</th></tr></thead>
      <tbody>${myCourses.map(c=>{
        const stu = DB.getEnrollments().filter(e=>e.courseId===c.id).length;
        const mat = DB.getMaterialsForCourse(c.id).length;
        return `<tr><td class="mono">${c.code}</td><td>${c.title}</td><td style="text-align:center">${c.units}</td><td style="text-align:center">${stu}</td><td style="text-align:center">${mat}</td></tr>`;
      }).join('')}</tbody>
    </table>`;
  }

  /* STUDENTS */
  function renderStudents() {
    const enrolled = DB.getEnrollments().filter(e=>myCourseIds.includes(e.courseId));
    const studentIds = [...new Set(enrolled.map(e=>e.studentId))];
    if (!studentIds.length) {
      document.getElementById('studentsTable').innerHTML = '<div class="empty-state"><div class="ico">ğŸ“</div><p>No students enrolled in your courses yet.</p></div>';
      return;
    }
    document.getElementById('studentsTable').innerHTML = `<table>
      <thead><tr><th>Matric</th><th>Name</th><th>Department</th><th>Level</th><th>Courses (yours)</th><th>GPA</th></tr></thead>
      <tbody>${studentIds.map(sid=>{
        const sp = DB.studentFullProfile(sid)||{};
        const courses = enrolled.filter(e=>e.studentId===sid).map(e=>{ const c=DB.getCourseById(e.courseId); return c?c.code:''; }).join(', ');
        return `<tr>
          <td class="mono">${sp.matric||'â€”'}</td><td>${sp.name||'â€”'}</td>
          <td>${sp.department||'â€”'}</td><td>${sp.level||'â€”'}</td>
          <td>${courses}</td><td><strong style="color:var(--green-700)">${DB.calcGPA(sid)}</strong></td>
        </tr>`;
      }).join('')}</tbody>
    </table>`;
  }

  /* RESULTS */
  function populateResultSelects() {
    // All students enrolled in my courses
    const enrolled = DB.getEnrollments().filter(e=>myCourseIds.includes(e.courseId));
    const studentIds = [...new Set(enrolled.map(e=>e.studentId))];
    document.getElementById('rStudent').innerHTML = '<option value="">â€” Select student â€”</option>' +
      studentIds.map(sid=>{ const sp=DB.studentFullProfile(sid)||{}; return `<option value="${sid}">${sp.matric||sid} â€” ${sp.name||'Unknown'}</option>`; }).join('');
    document.getElementById('rCourse').innerHTML = '<option value="">â€” Select course â€”</option>' +
      myCourses.map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
  }

  function submitResult() {
    const sId  = document.getElementById('rStudent').value;
    const cId  = document.getElementById('rCourse').value;
    const score= parseInt(document.getElementById('rScore').value);
    if (!sId||!cId||isNaN(score)) { showAlert('r-err','error','âš  Please fill all fields.'); return; }
    if (score<0||score>100)       { showAlert('r-err','error','âš  Score must be 0â€“100.'); return; }
    if (!myCourseIds.includes(cId)) { showAlert('r-err','error','âš  You can only enter results for your own courses.'); return; }
    DB.upsertResult(sId, cId, score, user);
    showAlert('r-ok','success','âœ… Result saved â€” Grade: '+DB.scoreToGrade(score));
    document.getElementById('rScore').value='';
    renderResults();
  }

  function renderResults() {
    const results = DB.getResults().filter(r=>myCourseIds.includes(r.courseId));
    if (!results.length) { document.getElementById('resultsTable').innerHTML='<div class="empty-state"><div class="ico">ğŸ“Š</div><p>No results yet.</p></div>'; return; }
    const gc = {A:'var(--grade-A)',B:'var(--grade-B)',C:'var(--grade-C)',D:'var(--grade-D)',F:'var(--grade-F)'};
    document.getElementById('resultsTable').innerHTML = `<table>
      <thead><tr><th>Student</th><th>Matric</th><th>Course</th><th>Score</th><th>Grade</th><th>Updated</th></tr></thead>
      <tbody>${results.map(r=>{
        const sp=DB.studentFullProfile(r.studentId)||{};
        const c=DB.getCourseById(r.courseId)||{};
        const fill=r.score>=70?'#43a047':r.score>=50?'#fb8c00':'#e53935';
        return `<tr>
          <td>${sp.name||'â€”'}</td><td class="mono">${sp.matric||'â€”'}</td>
          <td>${c.code||'â€”'}</td>
          <td><div class="score-bar-row"><span style="width:32px;font-weight:600">${r.score}</span>
            <div class="score-bar"><div class="score-bar-fill" style="width:${r.score}%;background:${fill}"></div></div></div></td>
          <td><div class="grade-badge" style="background:${gc[r.grade]||'#333'}">${r.grade}</div></td>
          <td style="font-size:12px;color:var(--text-muted)">${r.updatedAt}</td>
        </tr>`;
      }).join('')}</tbody>
    </table>`;
  }

  /* MATERIALS */
  function populateMaterialSelect() {
    document.getElementById('mCourse').innerHTML = '<option value="">â€” Select course â€”</option>' +
      myCourses.map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
  }

  function uploadMaterial() {
    const courseId = document.getElementById('mCourse').value;
    const type     = document.getElementById('mType').value;
    const title    = document.getElementById('mTitle').value.trim();
    const fileEl   = document.getElementById('mFile');
    const file     = fileEl.files[0];
    if (!courseId||!title||!file) { showAlert('m-err','error','âš  Please fill all fields and select a file.'); return; }
    if (file.size>10*1024*1024)   { showAlert('m-err','error','âš  File too large. Max 10MB.'); return; }
    if (!myCourseIds.includes(courseId)) { showAlert('m-err','error','âš  You can only upload to your own courses.'); return; }
    const reader = new FileReader();
    reader.onload = e => {
      DB.uploadMaterial({ courseId, title, type, filename:file.name, data:e.target.result, size:(file.size/1024).toFixed(1)+' KB', uploadedBy:user });
      showAlert('m-ok','success','âœ… Material uploaded!');
      document.getElementById('mTitle').value=''; fileEl.value='';
      renderMaterials();
    };
    reader.readAsDataURL(file);
  }

  function renderMaterials() {
    const mats = DB.getMaterials().filter(m=>myCourseIds.includes(m.courseId));
    const el = document.getElementById('matsGrid');
    if (!mats.length) { el.innerHTML='<div class="empty-state"><div class="ico">ğŸ“š</div><p>No materials uploaded yet.</p></div>'; return; }
    el.innerHTML='<div class="mat-grid">'+mats.map(m=>{
      const c=DB.getCourseById(m.courseId)||{};
      return `<div class="mat-card">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <span class="badge badge-student">${c.code||'â€”'}</span>
          <span class="badge badge-type">${m.type}</span>
        </div>
        <h4>${m.title}</h4>
        <div class="meta">ğŸ“„ ${m.filename} Â· ${m.size}</div>
        <div class="meta">Uploaded ${m.uploadedAt}</div>
        <div style="display:flex;gap:8px;margin-top:4px">
          <a href="${m.data}" download="${m.filename}" class="btn btn-primary btn-sm">â¬‡ Download</a>
          <button class="btn btn-danger btn-sm" onclick="deleteMat('${m.id}')">ğŸ—‘</button>
        </div>
      </div>`;
    }).join('')+'</div>';
  }

  function deleteMat(id) {
    if (!confirm('Delete this material?')) return;
    DB.deleteMaterial(id); renderMaterials();
  }

  /* AUDIT */
  function renderAudit() {
    const trail = DB.getAuditTrail().filter(a=>a.actorId===user.id).reverse();
    if (!trail.length) { document.getElementById('auditTable').innerHTML='<div class="empty-state"><div class="ico">ğŸ”</div><p>No grade changes recorded yet.</p></div>'; return; }
    document.getElementById('auditTable').innerHTML = `<table>
      <thead><tr><th>Timestamp</th><th>Student</th><th>Course</th><th>Old Grade</th><th>New Grade</th><th>Reason</th></tr></thead>
      <tbody>${trail.map(a=>{
        const sp=DB.studentFullProfile(a.studentId)||{};
        const c=DB.getCourseById(a.courseId)||{};
        return `<tr>
          <td style="font-family:monospace;font-size:12px">${a.ts}</td>
          <td>${sp.name||'â€”'} <span style="color:var(--text-muted);font-size:11px">(${sp.matric||''})</span></td>
          <td>${c.code||'â€”'}</td>
          <td style="color:#e53935;font-weight:700">${a.oldGrade}</td>
          <td style="color:var(--grade-A);font-weight:700">${a.newGrade}</td>
          <td style="font-size:12px;color:var(--text-muted)">${a.reason}</td>
        </tr>`;
      }).join('')}</tbody>
    </table>`;
  }


  /* â”€â”€ FEEDBACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function buildStars(containerId, hiddenId) {
    const row = document.getElementById(containerId);
    row.innerHTML = '';
    for (let i = 1; i <= 5; i++) {
      const span = document.createElement('span');
      span.className = 'star';
      span.textContent = 'â˜…';
      span.dataset.val = i;
      span.onclick = () => setStars(containerId, hiddenId, i);
      span.onmouseover = () => hoverStars(containerId, i);
      span.onmouseout  = () => resetStars(containerId, hiddenId);
      row.appendChild(span);
    }
  }

  function setStars(containerId, hiddenId, val) {
    document.getElementById(hiddenId).value = val;
    updateStarDisplay(containerId, val);
  }

  function hoverStars(containerId, val) {
    document.querySelectorAll('#'+containerId+' .star').forEach((s,i) => {
      s.classList.toggle('active', i < val);
    });
  }

  function resetStars(containerId, hiddenId) {
    const val = parseInt(document.getElementById(hiddenId).value) || 0;
    updateStarDisplay(containerId, val);
  }

  function updateStarDisplay(containerId, val) {
    document.querySelectorAll('#'+containerId+' .star').forEach((s,i) => {
      s.classList.toggle('active', i < val);
    });
  }

  function starsHtml(val) {
    return Array.from({length:5},(_,i)=>`<span style="color:${i<val?'#f59e0b':'#ddd'};font-size:18px">â˜…</span>`).join('');
  }

  function renderFeedback() {
    buildStars('s-ease','fbEase');
    buildStars('s-speed','fbSpeed');
    buildStars('s-sat','fbSat');

    const existing = DB.getUserFeedback(user.id);
    if (existing) {
      document.getElementById('fbAlreadyMsg').style.display='block';
      document.getElementById('fbEase').value  = existing.easeOfUse;
      document.getElementById('fbSpeed').value = existing.speed;
      document.getElementById('fbSat').value   = existing.satisfaction;
      document.getElementById('fbComment').value = existing.comments||'';
      updateStarDisplay('s-ease',  existing.easeOfUse);
      updateStarDisplay('s-speed', existing.speed);
      updateStarDisplay('s-sat',   existing.satisfaction);
      document.getElementById('myFeedbackDisplay').innerHTML = `
        <div class="fb-display-row"><span>Ease of Use</span><span class="fb-stars">${starsHtml(existing.easeOfUse)} <strong>${existing.easeOfUse}/5</strong></span></div>
        <div class="fb-display-row"><span>Speed vs Manual</span><span class="fb-stars">${starsHtml(existing.speed)} <strong>${existing.speed}/5</strong></span></div>
        <div class="fb-display-row"><span>Overall Satisfaction</span><span class="fb-stars">${starsHtml(existing.satisfaction)} <strong>${existing.satisfaction}/5</strong></span></div>
        <div class="fb-display-row"><span>Comments</span><span style="font-size:13px;color:var(--text-muted);max-width:200px;text-align:right">${existing.comments||'â€”'}</span></div>
        <div style="font-size:11px;color:var(--text-muted);margin-top:10px">Submitted: ${existing.submittedAt}</div>`;
    }
  }

  function submitFeedback() {
    const ease = parseInt(document.getElementById('fbEase').value);
    const spd  = parseInt(document.getElementById('fbSpeed').value);
    const sat  = parseInt(document.getElementById('fbSat').value);
    const comments = document.getElementById('fbComment').value.trim();
    const err = document.getElementById('fb-err');
    const ok  = document.getElementById('fb-ok');
    err.classList.remove('show'); ok.classList.remove('show');
    if (!ease||!spd||!sat) { err.textContent='âš  Please rate all three categories.'; err.classList.add('show'); return; }
    DB.submitFeedback({ userId: user.id, userName: user.name, role: user.role, easeOfUse: ease, speed: spd, satisfaction: sat, comments });
    ok.textContent = 'âœ… Thank you! Your feedback has been recorded.';
    ok.classList.add('show');
    renderFeedback();
  }

  const renders = {
    overview: renderOverview,
    students: renderStudents,
    results: () => { populateResultSelects(); renderResults(); },
    materials: () => { populateMaterialSelect(); renderMaterials(); },
    audit: renderAudit,
    feedback: renderFeedback
  };

  renderOverview();
</script>
</body>
</html>
